# Архитектура автономного приложения для http_complex_control_execute

Документ описывает целевую архитектуру автономного приложения, которое:

- работает по логинам/паролям из локальной базы;
- на старте проверяет «доверенное время» через сеть;
- допускает работу только при наличии одноразового кода (на 30 суток);
- разрешает обновление базы только по одноразовому коду.

## 1. Цели и основные требования

- **Лицензия на 30 суток** по одноразовому коду (RUN_30D).
- **Однократное обновление базы** по одноразовому коду (DB_UPDATE).
- **Доверенное время по сети**: приложение не должно полагаться только на локальные часы.
- **Защита от подмены/отката базы** и от отката состояния лицензии.

## 2. Угрозы и ограничения офлайн-модели

- Пользователь может копировать/подменять файлы базы и состояния.
- Можно менять системное время и пытаться «продлить» лицензию.
- Возможен реверс-ингиниринг и патч бинарника.

**Важно:** без серверной регистрации «глобальная одноразовость» недостижима. В офлайн‑модели гарантируется:

- неподделываемость кода (подпись);
- одноразовость в рамках конкретной установки (защищённое состояние + анти‑rollback);
- обнаружение подмены/отката базы.

## 3. Компоненты приложения

### 3.1 LicenseManager

Функции:

- принимает код пользователя;
- проверяет подпись (публичный ключ в клиенте);
- проверяет уникальность `serial` (не использован);
- применяет «энтитлмент»:
  - **RUN_30D** → выставляет `expiry = trusted_now + 30 суток`;
  - **DB_UPDATE** → разрешает импорт конкретной базы.

### 3.2 TrustedTimeService

Функции:

- получает время по сети:
  - NTP/NTS (основной канал),
  - HTTPS Date (резервный канал);
- сравнивает источники (допуск, например ±5 минут);
- сохраняет `last_trusted_utc` и блокирует запуск при откате часов.

### 3.3 SecureStateStore

Хранит в защищённом хранилище ОС:

- список использованных `serial` (или их хеши);
- `expiry` лицензии;
- `last_trusted_utc`;
- `last_db_version`;
- ключ шифрования базы (или ключ для расшифровки ключа).

Рекомендованные хранилища:

- **Windows:** DPAPI (CryptProtectData).
- **macOS:** Keychain.
- **Linux:** Secret Service API (GNOME Keyring/KWallet).

### 3.4 DatabaseManager

- хранит базу в шифрованном виде (SQLCipher или AES‑обёртка);
- при обновлении сверяет **hash** и **версию** с кодом DB_UPDATE;
- запрещает rollback: `db_version` строго возрастает.

## 4. Формат одноразового кода

Код = `payload + signature`, упакованные в Base32/Base64URL.

Минимальный payload:

- `type`: RUN_30D или DB_UPDATE
- `serial`: уникальный идентификатор
- `issued_at_utc`
- `machine_binding` (рекомендуется)
- Для RUN_30D: `duration_days = 30`
- Для DB_UPDATE: `db_target_sha256`, `db_target_version`, `db_uuid`

Подпись выполняется закрытым ключом генератора (Ed25519/ECDSA/RSA). Клиент содержит только публичный ключ.

## 5. Логика «одноразовости»

1. Пользователь вводит код.
2. Клиент проверяет подпись и условия.
3. Клиент **атомарно**:
   - записывает `serial` как использованный;
   - обновляет `expiry` или разрешение на импорт базы;
   - обновляет `last_trusted_utc`.
4. Повторное применение того же `serial` отклоняется.

## 6. Проверка доверенного времени

Рекомендуемый алгоритм:

- На старте получить время по 2–3 источникам (NTP + HTTPS Date).
- Если источники расходятся больше порога — блокировать запуск.
- Записать `last_trusted_utc` и сравнивать при каждом запуске.

## 7. Обновление базы по коду

1. Пользователь вводит код типа **DB_UPDATE**.
2. Приложение проверяет подпись и одноразовость.
3. Разрешается импорт базы, если:
   - `sha256` файла совпадает с `db_target_sha256`;
   - `db_target_version > last_db_version`.
4. Приложение записывает новый `last_db_version`.

## 8. Генератор одноразовых кодов

- отдельная программа (админ‑утилита);
- хранит закрытый ключ подписи;
- ведёт журнал выданных кодов (serial, тип, дата, кому выдан).

## 9. Минимальный набор тестов

- RUN_30D активирует работу на 30 суток от `trusted_now`;
- повторное применение одного и того же `serial` запрещено;
- DB_UPDATE разрешает импорт только совпадающей базы (hash + version);
- rollback времени блокируется до сетевой валидации;
- rollback базы отклоняется по версии.
